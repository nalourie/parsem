<!doctype html>
<html lang="en">
  <head>
    <title>Pars' 'Em Demo</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Demo page for parsem, a semantic parser for the browser.">
    <meta name="author" content="Nicholas Lourie">

    <link rel="stylesheet" type="text/css" href="style.css">
  </head>
  <body>

    <div class="banner">
      <h1>Pars' 'Em!</h1>
      <p class="lead">Semantic parsing for the browser.</p>
    </div>

    <div class="content">
      <div id="demo-description" class="card">
        <p>
          Pars' 'Em is a JavaScript semantic parsing framework.
          It provides you with a minimal set of tools for building
          semantic parsers that can run in the browser &mdash;
          transforming natural language text into structured
          representations on which you can compute.
        </p>

        <p>
          Try out the demo below!
        </p>

        <a href="https://github.com/nalourie/parsem">Github Repo</a>
      </div>

      <div id="demo-form" class="card">
        <form>
          <select id="demo-select-parser"></select>

          <p id="demo-parser-description"></p>

          <input
            id="demo-input"
            class="input"
            name="parse-text"
            type="text">
          <input
            id="demo-parse"
            class="button"
            type="submit"
            value="Parse!">
          <input
            id="demo-rank"
            class="button"
            type="button"
            value="Train Ranker">
        </form>
      </div>

      <div id="results" class="card">
        <div class="well">
          <p>
            <strong>Input:</strong>
            <span id="question"></span>
          </p>
          <p>
            <strong>Best Interpretation:</strong>
            <span id="answer"></span>
          </p>
          <p>
            <strong>Other Interpretations:</strong>
            <span id="other-answers"></span>
          </p>
          <hr>
          <p>
            <strong>Train Accuracy:</strong>
            <span id="ranker-train-accuracy"></span>
          </p>
          <p>
            <strong>Test Accuracy:</strong>
            <span id="ranker-test-accuracy"></span>
          </p>
        </div>
      </div>

    </div>

    <script src="./bundle.js"></script>
    <script>
      function submitDemoForm(e) {
        e.preventDefault();

        // fetch input and compute semantics
        var parser = document
          .getElementById("demo-select-parser")
          .value;
        var text = document
          .getElementById("demo-input")
          .value;
        var results = parsers[parser]
              .ranker
              .rankedParses(text)
              .map(([score, parse]) => parse.computeDenotation());
        var topResult = results[0];
        var otherResults = Array.from(new Set(results))
         .map(v => JSON.stringify(v))
         .join(", ") || "Sorry, I didn't understand.";

        // clear the input
        document
          .getElementById("demo-input")
          .value = "";

        // display the result
        document
          .getElementById("question")
          .innerHTML = text;
        document
          .getElementById("answer")
          .innerHTML = topResult;
        document
          .getElementById("other-answers")
          .innerHTML = otherResults;

        return false;
      }

      function startTraining(e) {
        e.preventDefault();

        // fetch relevant variables
        var parser = document
          .getElementById("demo-select-parser")
          .value;

        var ranker = parsers[parser].ranker;
        var data = parsers[parser].data;

        if (!ranker) {
          alert(`No ranker is attached to ${parser}`);
          return;
        }

        // notify the user that we're fitting the ranker
        var curtain = document.createElement('div');
        curtain.id = "curtain";
        curtain.className = "curtain";
        curtain.innerHTML = `<div class="spinner"></div>`

        document
          .getElementsByTagName('body')[0]
          .appendChild(curtain);

        // train the ranker
        setTimeout(trainRanker, 1, ranker, data);
      }

      function trainRanker(ranker, data) {
        // split the data
        var shuffledData = shuffle(data);

        var trainData = shuffledData.slice(
              0, Math.floor(0.6 * shuffledData.length)
        );
        var trainUtterances = trainData.map(
              ([utterance, denotation]) => utterance
        );
        var trainDenotations = trainData.map(
              ([utterance, denotation]) => denotation
        );

        var testData = shuffledData.slice(
              Math.floor(0.6 * shuffledData.length)
        );
        var testUtterances = testData.map(
              ([utterance, denotation]) => utterance
        );
        var testDenotations = testData.map(
              ([utterance, denotation]) => denotation
        );

        // fit the ranker
        ranker.fit(trainUtterances, trainDenotations);

        // compute train / test accuracy
        var trainAccuracy = accuracy(
              trainUtterances.map(
                s => ranker.topParse(s).computeDenotation()
              ),
              trainDenotations
        );
        var testAccuracy = accuracy(
              testUtterances.map(
                s => ranker.topParse(s).computeDenotation()
              ),
              testDenotations
        );

        // remove the spinner / waiting UI components
        document.getElementById('curtain').remove();

        // update the UI
        document
          .getElementById('ranker-train-accuracy')
          .innerHTML = trainAccuracy.toString().slice(0,4);
        document
          .getElementById('ranker-test-accuracy')
          .innerHTML = testAccuracy.toString().slice(0,4);
      }

      function setExampleParser() {
        var parser = document
          .getElementById("demo-select-parser")
          .value;
        var description = parsers[parser].description;
        var example = parsers[parser].example;

        // display the parser's description
        document
          .getElementById("demo-parser-description")
          .innerHTML = `<strong>${parser}</strong>: ${description}`;

        // set the example input
        document
          .getElementById("demo-input")
          .value = example;

        // reset the results display
        document
          .getElementById("question")
          .innerHTML = "The input text will go here.";

        document
          .getElementById("answer")
          .innerHTML = "Top scoring computed semantics will go here.";

        document
          .getElementById("other-answers")
          .innerHTML = "Different possible computed semantics of the"
            + " text will go here.";

        document
          .getElementById("ranker-train-accuracy")
          .innerHTML = "N/A";

        document
          .getElementById("ranker-test-accuracy")
          .innerHTML = "N/A";
      }

      // add the parsers to the select field
      for (var parser in parsers) {
        var parserOption = document.createElement('option');
        parserOption.value = parser;
        parserOption.innerHTML = parser;
        document
          .getElementById("demo-select-parser")
          .appendChild(parserOption);
      }
      // initialize demo input
      setExampleParser();

      // attach setExampleParser to demo-select-parser
      document
        .getElementById("demo-select-parser")
        .addEventListener("change", setExampleParser);

      // attach submitDemoForm to the demo form
      document
        .getElementById("demo-form")
        .addEventListener("submit", submitDemoForm);

      // attach trainRanker to the demo-rank button
      document
        .getElementById("demo-rank")
        .addEventListener("click", startTraining);
    </script>
  </body>
</html>
